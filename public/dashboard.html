<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1e1e2f; color: white; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 30px; background: #111; box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    header h1 { margin: 0; font-size: 22px; color: #3498db; }
    nav button {
      margin-left: 15px; padding: 8px 16px; border: none; border-radius: 8px;
      background: #3498db; color: white; cursor: pointer; transition: 0.3s;
    }
    nav button:hover { background: #2980b9; transform: scale(1.05); }
    .container { padding: 20px; }
    h2 { border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-top: 25px; margin-bottom: 15px; }
    .grid { display: flex; flex-wrap: wrap; gap: 15px; }
    .card {
      background: #2c2c3c; padding: 12px; border-radius: 8px;
      width: 200px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .card img { max-width: 100%; height: 120px; object-fit: contain; margin-bottom: 8px; }
    .card-title { font-size: 14px; margin: 8px 0; }
    .card button {
      margin: 4px; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer;
    }
    .btn-download { background: #2ecc71; color: white; }
    .btn-delete { background: #e74c3c; color: white; }
  </style>
</head>
<body>
  <header>
    <h1>üìÇ Portafolio</h1>
    <nav>
      <button onclick="showProfile()">Perfil</button>
      <button onclick="showPortfolio()">Portafolio</button>
      <button onclick="logout()">Salir</button>
    </nav>
  </header>

  <div class="container">
    <section id="profile" style="display:none;">
      <h2>üë§ Perfil de creador</h2>
      <p><strong>Alumno:</strong> Sebastian Limaylla</p>
      <p><strong>Curso:</strong> Arquitectura de Software</p>
      <h2>üë§ Perfil de usuario</h2>
      <p id="user-info"></p>
    </section>

     <section id="portfolio">
    <h2>üìÇ Archivos del Portafolio</h2>

    <!-- Formulario de subida SOLO visible para admin -->
    <form id="uploadForm" enctype="multipart/form-data" style="display:none; margin-bottom:20px;">
      <input type="file" name="file" required>
      <input type="text" name="title" placeholder="T√≠tulo del archivo">
      <select name="semana" required>

        <script>
  // Supongamos que el rol viene guardado en localStorage al hacer login
  const userRole = localStorage.getItem("role");

  if (userRole === "admin") {
    document.getElementById("uploadForm").style.display = "block";
  } else {
    document.getElementById("uploadForm").style.display = "none";
  }
</script>

        <!-- Las 16 semanas -->
        <option value="1">Semana 1</option>
        <option value="2">Semana 2</option>
        <option value="3">Semana 3</option>
        <option value="4">Semana 4</option>
        <option value="5">Semana 5</option>
        <option value="6">Semana 6</option>
        <option value="7">Semana 7</option>
        <option value="8">Semana 8</option>
        <option value="9">Semana 9</option>
        <option value="10">Semana 10</option>
        <option value="11">Semana 11</option>
        <option value="12">Semana 12</option>
        <option value="13">Semana 13</option>
        <option value="14">Semana 14</option>
        <option value="15">Semana 15</option>
        <option value="16">Semana 16</option>
      </select>
      <button type="submit">Subir</button>
    </form>

      <!-- Contenedor din√°mico de semanas -->
      <div id="portafolio"></div>
    </section>
  </div>

  <script>
    const API_URL = "http://localhost:3000";
    let currentUser = null;

    async function getUser() {
      if (localStorage.getItem("guest")) {
        document.getElementById("user-info").innerText = "üë§ Invitado | Rol: user";
        loadFiles();
        return;
      }

      const res = await fetch(`${API_URL}/api/user`, { credentials: "include" });
      if (!res.ok) {
        alert("‚ö†Ô∏è Sesi√≥n expirada. Vuelve a iniciar sesi√≥n.");
        window.location.href = "index.html";
        return;
      }

      currentUser = await res.json();
      document.getElementById("user-info").innerText =
        `üë§ Usuario: ${currentUser.username} | Rol: ${currentUser.role}`;

      if (currentUser.role === "admin") {
        document.getElementById("uploadForm").style.display = "block";
      }
      loadFiles();
    }

// Mostrar archivos agrupados por semana
async function loadFiles() {
  const portafolioDiv = document.getElementById("portafolio");
  portafolioDiv.innerHTML = "";

  for (let semana = 1; semana <= 16; semana++) {
    const res = await fetch(`${API_URL}/files/${semana}`, { credentials: "include" });
    const files = await res.json();

    const section = document.createElement("div");
    section.innerHTML = `<h2>Semana ${semana}</h2><div id="semana-${semana}" class="grid"></div>`;
    portafolioDiv.appendChild(section);

    const grid = section.querySelector(".grid");

    files.forEach(file => {
      const card = document.createElement("div");
      card.className = "card";

      let preview = "";
      if (file.filename.match(/\.(jpg|jpeg|png|gif)$/i)) {
        // Imagen con enlace
        preview = `
          <a href="${API_URL}/uploads/${file.filename}" target="_blank">
            <img src="${API_URL}/uploads/${file.filename}" alt="preview">
          </a>
        `;
      } else if (file.filename.match(/\.pdf$/i)) {
        // PDF con enlace
        preview = `
          <a href="${API_URL}/uploads/${file.filename}" target="_blank">
            <iframe src="${API_URL}/uploads/${file.filename}" 
                    class="preview-pdf"
                    width="100%" height="200px"></iframe>
          </a>
        `;
      } else {
        // Otros archivos
        preview = `
          <a href="${API_URL}/uploads/${file.filename}" target="_blank">
            <img src="https://img.icons8.com/color/96/pdf.png" alt="archivo">
          </a>
        `;
      }

      card.innerHTML = `
        ${preview}
        <div class="card-title">${file.title || file.filename}</div>
        <button class="btn-view" onclick="viewFile('${file.filename}')">Ver</button>
        <button class="btn-download" onclick="downloadFile('${file.filename}')">Descargar</button>
        ${currentUser?.role === "admin"
        ? `<button class="btn-delete" onclick="deleteFile(${file.id})">Eliminar</button>` : ""}
        `;
      grid.appendChild(card);
    });
  }
}
    function viewFile(filename) {
  window.open(`${API_URL}/uploads/${filename}`, "_blank");
}

    // Subida de archivo
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      const res = await fetch(`${API_URL}/upload`, {
        method: "POST",
        body: formData,
        credentials: "include"
      });

      const data = await res.json();
      alert(data.message);
      loadFiles();
      e.target.reset();
    });

    function downloadFile(filename) {
      window.location.href = `${API_URL}/download/${filename}`;
    }

    async function deleteFile(id) {
      if (!confirm("¬øSeguro que deseas eliminar este archivo?")) return;

      const res = await fetch(`${API_URL}/files/${id}`, {
        method: "DELETE",
        credentials: "include"
      });
      const data = await res.json();
      alert(data.message);
      loadFiles();
    }

    async function logout() {
      await fetch(`${API_URL}/logout`, { method: "POST", credentials: "include" });
      localStorage.removeItem("guest");
      window.location.href = "index.html";
    }

    function showProfile() {
      document.getElementById("profile").style.display = "block";
      document.getElementById("portfolio").style.display = "none";
    }

    function showPortfolio() {
      document.getElementById("profile").style.display = "none";
      document.getElementById("portfolio").style.display = "block";
    }

    window.onload = getUser;
  </script>
</body>
</html>
